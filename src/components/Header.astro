---
import { createTranslator } from "../locales";

const { lang } = Astro.params;
const currentLang = lang || "en";
const { pathname } = Astro.url;

const __ = createTranslator(currentLang as "id" | "en");

// Helper untuk link internal agar selalu membawa prefix bahasa
const localeLink = (path: string) => {
  const cleanPath = path.startsWith("/") ? path.slice(1) : path;
  return `/${currentLang}/${cleanPath}`;
};

// Helper untuk cek active state
const isActive = (path: string) => {
  if (path === "")
    return pathname === `/${currentLang}` || pathname === `/${currentLang}/`;
  const targetPath = localeLink(path);
  return pathname.startsWith(targetPath);
};
---

<header
  class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm sticky top-0 z-40 border-b border-gray-200/80 dark:border-gray-700/80"
>
  <div class="container mx-auto max-w-screen-xl px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-16">
      {/* Logo */}
      <div class="flex-shrink-0">
        <a
          href={localeLink("/")}
          class="text-2xl font-bold text-indigo-600 dark:text-indigo-400"
        >
          <span class="text-black dark:text-white">Fian's</span> Blog
        </a>
      </div>

      {/* Desktop Navigation */}
      <nav class="hidden md:flex md:items-center md:space-x-8">
        <a
          href={localeLink("/")}
          class={`transition-colors ${isActive("") ? "text-indigo-600 dark:text-indigo-400 font-semibold" : "text-gray-700 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400"}`}
        >
          {__("Home")}
        </a>
        <a
          href={localeLink("blog")}
          class={`transition-colors ${isActive("blog") ? "text-indigo-600 dark:text-indigo-400 font-semibold" : "text-gray-700 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400"}`}
        >
          {__("Blog")}
        </a>
        <a
          href={localeLink("about")}
          class={`transition-colors ${isActive("about") ? "text-indigo-600 dark:text-indigo-400 font-semibold" : "text-gray-700 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400"}`}
        >
          {__("About")}
        </a>

        {/* Theme Toggle */}
        <div class="relative">
          <button
            id="theme-toggle"
            class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
            aria-label="Toggle Theme"
          >
            <svg
              id="theme-icon"
              class="w-5 h-5 text-gray-700 dark:text-gray-300"
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
            </svg>
          </button>
        </div>

        {/* Language Toggle */}
        <div class="relative">
          <button
            id="lang-toggle"
            class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center gap-1"
            aria-label="Change Language"
          >
            <span
              class="text-sm font-medium uppercase text-gray-700 dark:text-gray-300"
              >{currentLang}</span
            >
            <svg
              class="w-4 h-4 text-gray-700 dark:text-gray-300"
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M6 9l6 6 6-6"></path>
            </svg>
          </button>
          <div
            id="lang-dropdown"
            class="absolute right-0 mt-2 w-32 bg-white dark:bg-gray-800 rounded-md shadow-lg py-1 hidden z-50 ring-1 ring-black ring-opacity-5"
          >
            <a
              href="#"
              data-lang="en"
              class={`block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 lang-option ${currentLang === "en" ? "text-indigo-600 font-bold" : "text-gray-700 dark:text-gray-300"}`}
            >
              English
            </a>
            <a
              href="#"
              data-lang="id"
              class={`block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 lang-option ${currentLang === "id" ? "text-indigo-600 font-bold" : "text-gray-700 dark:text-gray-300"}`}
            >
              Indonesia
            </a>
          </div>
        </div>
      </nav>

      {/* Mobile Menu Toggle */}
      <div class="md:hidden flex items-center space-x-2">
        <button
          id="theme-toggle-mobile"
          class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
        >
          <svg
            id="theme-icon-mobile"
            class="w-5 h-5 text-gray-700 dark:text-gray-300"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
          </svg>
        </button>

        <div class="relative">
          <button
            id="lang-toggle-mobile"
            class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex items-center"
          >
            <span
              class="text-sm font-bold uppercase text-gray-700 dark:text-gray-300 mr-1"
              >{currentLang}</span
            >
          </button>
          <div
            id="lang-dropdown-mobile"
            class="absolute right-0 mt-2 w-32 bg-white dark:bg-gray-800 rounded-md shadow-lg py-1 hidden z-50 ring-1 ring-black ring-opacity-5"
          >
            <a
              href="#"
              data-lang="en"
              class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 lang-option-mobile"
              >English</a
            >
            <a
              href="#"
              data-lang="id"
              class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 lang-option-mobile"
              >Indonesia</a
            >
          </div>
        </div>

        <button
          id="mobile-menu-toggle"
          class="text-gray-500 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400 p-2"
        >
          <svg
            id="menu-icon"
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 6h16M4 12h16m-7 6h7"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>

  {/* Mobile Menu */}
  <div
    id="mobile-menu"
    class="md:hidden max-h-0 opacity-0 invisible overflow-hidden transition-all duration-300 ease-in-out bg-white/95 dark:bg-gray-800/95 backdrop-blur-sm border-t border-gray-200 dark:border-gray-700 absolute top-16 left-0 right-0 z-50 shadow-xl"
  >
    <div class="px-4 py-5 space-y-1 h-[calc(100vh-4rem)]">
      <a
        href={localeLink("")}
        class={`block px-4 py-3 rounded-lg text-base font-medium ${isActive("") ? "text-white bg-indigo-600" : "text-gray-700 dark:text-gray-200 hover:text-white hover:bg-indigo-600"} transition-colors`}
      >
        {__("Home")}
      </a>
      <a
        href={localeLink("blog")}
        class={`block px-4 py-3 rounded-lg text-base font-medium ${isActive("blog") ? "text-white bg-indigo-600" : "text-gray-700 dark:text-gray-200 hover:text-white hover:bg-indigo-600"} transition-colors`}
      >
        {__("Blog")}
      </a>
      <a
        href={localeLink("about")}
        class={`block px-4 py-3 rounded-lg text-base font-medium ${isActive("about") ? "text-white bg-indigo-600" : "text-gray-700 dark:text-gray-200 hover:text-white hover:bg-indigo-600"} transition-colors`}
      >
        {__("About")}
      </a>
    </div>
  </div>
</header>

<script>
  function initHeader() {
    // Mobile Menu
    const mobileMenuToggle = document.getElementById("mobile-menu-toggle");
    const mobileMenu = document.getElementById("mobile-menu");
    const menuIcon = document.getElementById("menu-icon");

    if (mobileMenuToggle && mobileMenu && menuIcon) {
      // Clone element to remove old event listeners if using ViewTransitions
      const newToggle = mobileMenuToggle.cloneNode(true);
      mobileMenuToggle.parentNode?.replaceChild(newToggle, mobileMenuToggle);

      newToggle.addEventListener("click", function () {
        const isClosed = mobileMenu.classList.contains("max-h-0");
        if (isClosed) {
          mobileMenu.classList.remove("max-h-0", "opacity-0", "invisible");
          mobileMenu.classList.add("max-h-screen", "opacity-100", "visible");
          menuIcon.innerHTML =
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>';
        } else {
          mobileMenu.classList.add("max-h-0", "opacity-0", "invisible");
          mobileMenu.classList.remove("max-h-screen", "opacity-100", "visible");
          menuIcon.innerHTML =
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>';
        }
      });
    }

    // Theme Logic
    const themeToggles = [
      document.getElementById("theme-toggle"),
      document.getElementById("theme-toggle-mobile"),
    ];
    const themeIcons = [
      document.getElementById("theme-icon"),
      document.getElementById("theme-icon-mobile"),
    ];

    function updateIcons(theme: string) {
      const darkPath =
        '<circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M22 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/>';
      const lightPath = '<path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>';

      themeIcons.forEach((icon) => {
        if (icon) icon.innerHTML = theme === "dark" ? darkPath : lightPath;
      });
    }

    function setTheme(theme: string) {
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem("theme", theme);
      document.cookie = `theme=${theme}; path=/; max-age=31536000`; // Backup for SSR
      if (theme === "dark") {
        document.documentElement.classList.add("dark");
      } else {
        document.documentElement.classList.remove("dark");
      }
      updateIcons(theme);
    }

    // Init Theme
    const storedTheme =
      localStorage.getItem("theme") ||
      (document.documentElement.classList.contains("dark") ? "dark" : "light");
    setTheme(storedTheme);

    themeToggles.forEach((btn) => {
      btn?.addEventListener("click", () => {
        const current =
          localStorage.getItem("theme") === "dark" ? "light" : "dark";
        setTheme(current);
      });
    });

    // Language Logic
    const langToggles = [
      {
        btn: document.getElementById("lang-toggle"),
        menu: document.getElementById("lang-dropdown"),
      },
      {
        btn: document.getElementById("lang-toggle-mobile"),
        menu: document.getElementById("lang-dropdown-mobile"),
      },
    ];

    function switchLanguage(targetLang: string) {
      const currentPath = window.location.pathname;
      const segments = currentPath.split("/").filter(Boolean); // remove empty strings

      // Asumsi struktur URL selalu /lang/page...
      // Jika segmen pertama adalah 'en' atau 'id', ganti. Jika tidak (root), tambah.
      if (
        segments.length > 0 &&
        (segments[0] === "en" || segments[0] === "id")
      ) {
        segments[0] = targetLang;
      } else {
        segments.unshift(targetLang);
      }

      const newPath = "/" + segments.join("/");
      window.location.href = newPath;
    }

    langToggles.forEach(({ btn, menu }) => {
      if (btn && menu) {
        // Toggle menu
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          menu.classList.toggle("hidden");
        });

        // Close when clicking outside
        document.addEventListener("click", (e) => {
          if (
            !btn.contains(e.target as Node) &&
            !menu.contains(e.target as Node)
          ) {
            menu.classList.add("hidden");
          }
        });

        // Handle Selection
        const options = menu.querySelectorAll("a[data-lang]");
        options.forEach((opt) => {
          opt.addEventListener("click", (e) => {
            e.preventDefault();
            const lang = opt.getAttribute("data-lang");
            if (lang) switchLanguage(lang);
            menu.classList.add("hidden");
          });
        });
      }
    });
  }

  // Run on load
  initHeader();

  // Re-run on View Transitions (Astro 3+)
  document.addEventListener("astro:page-load", initHeader);
</script>

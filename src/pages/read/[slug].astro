---
import { type CollectionEntry, getCollection, render } from "astro:content";
import BlogPost from "../../layouts/BlogPost.astro";
import { createTranslator } from "../../locales";
import { fetchGithubUser } from "../../utils/github-api";

export async function getStaticPaths() {
  const posts = await getCollection("blog");

  return posts.map((post) => ({
    params: {
      slug: post.data.slug,
    },
    props: post,
  }));
}

type Props = CollectionEntry<"blog">;

const lang = "en";
const post = Astro.props as Props;
const { Content } = await render(post);
const me = await fetchGithubUser("fiandev");

const __ = createTranslator(lang as "id" | "en");

const currentUrl = Astro.url;
---

<BlogPost {...post.data}>
  <main class="py-12 px-4">
    <article class="relative max-w-3xl mx-auto">
      <div
        id="floating-panel"
        class="-translate-x-[90%] transition-transform duration-300 ease-out fixed left-0 top-1/2 p-4 backdrop-blur-sm lg:backdrop-blur-none rounded-lg bg-indigo-200/80 dark:bg-gray-800/80 dark:lg:bg-transparent lg:bg-transparent h-fit lg:absolute lg:top-0 lg:-left-32 lg:h-full lg:block"
      >
        <div
          class="sticky top-32 flex flex-col items-center space-y-8 text-indigo-800 dark:text-indigo-200 lg:text-gray-500 dark:lg:text-gray-400"
        >
          <!-- <div class="flex flex-col items-center">
            <svg
              class="w-8 h-8"
              xmlns="http://www.w3.org/2000/svg"
              width="512"
              height="512"
              viewBox="0 0 512 512"
            >
              <path
                fill="currentColor"
                d="M235.094 17.844C60.934 66.176 249.458 163.35 184.72 198.22c-32.796 17.66-86.03 15.048-64.657-73.876c-106.688 86.723-75.665 284.316 48.093 349.5c-27.153-25.674-44.125-62.01-44.125-102.25c0-77.624 63.128-140.75 140.75-140.75c77.625 0 140.75 63.128 140.75 140.75c0 37.55-14.77 71.708-38.81 96.97c150.706-76.96 122.903-288.475 22.5-342.533c23.96 56.174 11.553 99.36-18.22 123.44C385.64 57.762 174.494 135.013 235.094 17.843zM264.78 249.53c-67.523 0-122.06 54.54-122.06 122.064s54.54 122.062 122.06 122.062c67.523 0 122.064-54.538 122.064-122.062c0-67.522-54.54-122.063-122.063-122.063zm0 53.782c46.983 0 85.283 38.3 85.283 85.282s-38.3 85.25-85.282 85.25c-46.98 0-85.25-38.268-85.25-85.25s38.27-85.28 85.25-85.28zm0 18.688c-36.88 0-66.56 29.712-66.56 66.594c0 36.88 29.68 66.562 66.56 66.562c36.882 0 66.595-29.68 66.595-66.562c0-36.88-29.712-66.594-66.594-66.594zm0 18.656c26.45 0 47.876 21.457 47.876 47.906c0 26.45-21.426 47.875-47.875 47.875c-26.447 0-47.905-21.425-47.905-47.875c0-8.41 2.19-16.315 6-23.187c1.84 12.334 12.466 21.813 25.313 21.813c14.14 0 25.593-11.486 25.593-25.625c0-8.62-4.25-16.236-10.78-20.875q.886-.032 1.78-.032z"
              ></path>
            </svg>
            <span class="text-sm mt-1 text-gray-700 dark:text-gray-300"
              >{post.data.views || 0}</span
            >
          </div> -->
          <button
            id="share-btn"
            class="hover:text-primary dark:hover:text-primary transition-colors"
          >
            <svg
              class="w-8 h-8"
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
            >
              <path
                fill="currentColor"
                d="M10.25 3a.75.75 0 0 1 0 1.5h-3.5A2.25 2.25 0 0 0 4.5 6.75v10.5l.012.23A2.25 2.25 0 0 0 6.75 19.5h10.5a2.25 2.25 0 0 0 2.25-2.25v-2a.75.75 0 0 1 1.5 0v2A3.75 3.75 0 0 1 17.25 21H6.75a3.75 3.75 0 0 1-3.745-3.557L3 17.25V6.75A3.75 3.75 0 0 1 6.75 3zm4.687-.932a.75.75 0 0 1 .801.113l7 6a.75.75 0 0 1 .032 1.109l-7 6.75a.75.75 0 0 1-1.27-.54v-2.976c-1.014.064-1.97.273-2.94.769c-1.136.581-2.344 1.581-3.689 3.303l-.271.354a.75.75 0 0 1-1.35-.45c0-2.857.687-5.59 2.168-7.628c1.376-1.893 3.41-3.147 6.082-3.344V2.75l.008-.109a.75.75 0 0 1 .429-.573"
              ></path>
            </svg>
          </button>
        </div>
      </div>

      <div class="text-center mb-8">
        <h1
          class="text-2xl md:text-4xl font-bold text-gray-900 dark:text-white font-sans leading-tight"
        >
          {post.data.title}
        </h1>
      </div>

      <img
        src={post.data.heroImage?.src}
        alt={post.data.title}
        width="800"
        height="450"
        loading="lazy"
        class="w-full h-auto max-h-96 bg-gray-300 dark:bg-gray-700 object-cover rounded-lg mb-8 shadow-lg"
      />

      <nav class="mb-6" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-2 text-sm">
          <li>
            <a
              href={`/${lang}`}
              class="text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition-colors"
              >{__("Home")}</a
            >
          </li>
          <li class="text-gray-400 dark:text-gray-500">/</li>
          <li>
            <a
              href={`/${lang}/blogs`}
              class="text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition-colors"
              >{__("Blogs")}</a
            >
          </li>
          <li class="text-gray-400 dark:text-gray-500">/</li>
          <li
            class="text-gray-900 dark:text-white font-medium truncate max-w-xs md:max-w-md"
          >
            {post.data.title.slice(0, 30)}
          </li>
        </ol>
      </nav>

      <div
        class="trix-content selection:bg-indigo-400/80 selection:text-slate-100 max-w-[68ch] md:max-w-fit"
      >
        <Content />
      </div>

      <div class="mt-12 flex flex-wrap gap-2">
        {
          post.data.categories?.map((category: string) => (
            <a
              href={`/${lang}/categories/${category}`}
              class="bg-gray-200/60 dark:bg-gray-700/60 text-gray-800 dark:text-gray-200 text-sm font-medium px-4 py-1.5 rounded-full hover:bg-primary/20 dark:hover:bg-primary/20 transition-colors"
            >
              {category}
            </a>
          ))
        }
      </div>

      <div
        class="mt-16 p-6 bg-gray-200/80 dark:bg-gray-800/80 rounded-2xl flex flex-col sm:flex-row sm:items-center gap-6"
      >
        <img
          src={me?.avatar_url}
          alt={`Foto Profil ${post.data.author?.name}`}
          width="80"
          height="80"
          loading="lazy"
          class="w-20 h-20 rounded-full object-cover ring-4 ring-white"
        />
        <div class="flex-grow">
          <p class="text-sm text-gray-500 dark:text-gray-400">
            {__("Written by")}
          </p>
          <p class="text-xl font-bold text-gray-900 dark:text-white">
            {me?.name}
          </p>
          <p class="mt-1 text-base text-gray-600 dark:text-gray-300">
            {
              me?.bio ??
                __(
                  "A passionate writer and developer who loves sharing stories through words."
                )
            }
          </p>
        </div>
      </div>
    </article>
  </main>

  <div
    id="share-modal"
    class="pointer-events-none opacity-0 fixed inset-0 bg-black/80 dark:bg-black/90 backdrop-blur-sm z-50 flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out"
  >
    <div
      id="share-modal-content"
      class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md relative transform transition-all duration-300 ease-in-out scale-95"
    >
      <button
        id="close-modal-btn"
        class="absolute top-4 right-4 text-gray-400 dark:text-gray-300 hover:text-gray-800 dark:hover:text-gray-200"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-6 w-6"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>

      <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
        {__("Share this article")}
      </h3>

      <div class="grid grid-cols-2 gap-4">
        <a
          href="https://www.facebook.com/sharer/sharer.php?u={{ $shareUrl }}"
          target="_blank"
          rel="noopener noreferrer"
          class="flex items-center space-x-3 p-3 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-primary/10 dark:hover:bg-primary/10 transition-colors"
        >
          <svg
            class="w-6 h-6 text-primary fill-blue-500"
            fill="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              d="M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-1.667c0-.955.192-1.333 1.115-1.333h2.885v-5h-3.808c-3.596 0-5.192 1.583-5.192 4.615v2.385z"
            ></path>
          </svg>
          <span class="font-medium text-gray-700 dark:text-gray-200"
            >{__("Facebook")}</span
          >
        </a>
        <a
          href="https://twitter.com/intent/tweet?url={{ $shareUrl }}&text={{ $shareTitle }}"
          target="_blank"
          rel="noopener noreferrer"
          class="flex items-center space-x-3 p-3 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-primary/10 dark:hover:bg-primary/10 transition-colors"
        >
          <svg
            class="w-6 h-6 text-primary fill-sky-400"
            fill="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616v.064c0 2.298 1.634 4.212 3.793 4.649-.65.177-1.354.23-2.06.088.608 1.923 2.366 3.256 4.472 3.304-1.996 1.564-4.522 2.37-7.24 2.04 2.263 1.456 4.949 2.309 7.816 2.309 9.38 0 14.502-7.784 14.248-14.757 1.017-.723 1.898-1.628 2.59-2.688z"
            ></path>
          </svg>
          <span class="font-medium text-gray-700 dark:text-gray-200"
            >{__("Twitter")}</span
          >
        </a>
        <a
          href="https://www.linkedin.com/shareArticle?mini=true&url={{ $shareUrl }}&title={{ $shareTitle }}"
          target="_blank"
          rel="noopener noreferrer"
          class="flex items-center space-x-3 p-3 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-primary/10 dark:hover:bg-primary/10 transition-colors"
        >
          <svg
            class="w-6 h-6 text-primary fill-blue-400"
            fill="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              d="M4.98 3.5c0 1.381-1.11 2.5-2.48 2.5s-2.48-1.119-2.48-2.5c0-1.38 1.11-2.5 2.48-2.5s2.48 1.12 2.48 2.5zm.02 4.5h-5v16h5v-16zm7.982 0h-4.968v16h4.969v-8.399c0-2.022.404-4.138 3.021-4.138 2.528 0 2.979 2.063 2.979 4.258v8.279h4.968v-9.09c0-4.308-2.304-7.82-6.23-7.82-2.924 0-4.522 1.634-5.258 3.109v-2.6h-4.968z"
            ></path>
          </svg>
          <span class="font-medium text-gray-700 dark:text-gray-200"
            >{__("LinkedIn")}</span
          >
        </a>
        <a
          href="https://api.whatsapp.com/send?text={{ $shareTitle }}%20{{ $shareUrl }}"
          target="_blank"
          rel="noopener noreferrer"
          class="flex items-center space-x-3 p-3 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-primary/10 dark:hover:bg-primary/10 transition-colors"
        >
          <svg
            class="w-6 h-6 text-green-500 fill-green-400"
            fill="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99 0-3.903-.52-5.586-1.459l-6.554 1.73zM7.51 5.586c-.333-.002-.658.063-.966.194-.308.13-.589.324-.82.573-.23.25-.414.545-.541.861-.127.316-.196.656-.197 1.002.001 1.671 1.364 3.033 3.035 3.033.43 0 .848-.095 1.23-.271.382-.176.71-.426.969-.734.259-.307.453-.669.566-1.059.113-.39.17-.801.17-1.211.001-1.671-1.363-3.033-3.034-3.033zM16.49 5.586c-.333-.002-.658.063-.966.194-.308.13-.589.324-.82.573-.23.25-.414.545-.541.861-.127.316-.196.656-.197 1.002.001 1.671 1.364 3.033 3.035 3.033.43 0 .848-.095 1.23-.271.382-.176.71-.426.969-.734.259-.307.453-.669.566-1.059.113-.39.17-.801.17-1.211.001-1.671-1.363-3.033-3.034-3.033z"
            ></path>
          </svg>
          <span class="font-medium text-gray-700 dark:text-gray-200"
            >{__("WhatsApp")}</span
          >
        </a>
      </div>

      <div class="mt-4">
        <label
          for="share-link-input"
          class="text-sm font-medium text-gray-600 dark:text-gray-300"
          >{__("Or copy link")}</label
        >
        <div class="mt-1 flex rounded-md shadow-sm">
          <input
            type="text"
            id="share-link-input"
            value={currentUrl.href}
            readonly
            class="flex-1 block w-full rounded-none rounded-l-md border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:ring-primary focus:border-primary sm:text-sm p-2 text-gray-700 dark:text-gray-200"
          />
          <button
            id="copy-link-btn"
            class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-primary/10 dark:hover:bg-primary/10"
          >
            <svg
              id="copy-icon"
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
              ></path>
            </svg>
            <svg
              id="copied-icon"
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 text-green-500 hidden"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M5 13l4 4L19 7"></path>
            </svg>
            <span id="copy-text" class="ml-2">{__("Copy")}</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script is:inline>
    document.addEventListener("DOMContentLoaded", () => {
      const shareBtn = document.getElementById("share-btn");
      const shareModal = document.getElementById("share-modal");
      const modalContent = document.getElementById("share-modal-content");
      const closeModalBtn = document.getElementById("close-modal-btn");

      const openModal = () => {
        shareModal.classList.remove("opacity-0", "pointer-events-none");
        modalContent.classList.remove("scale-95");
      };

      const closeModal = () => {
        modalContent.classList.add("scale-95");
        shareModal.classList.add("opacity-0");
        setTimeout(() => {
          shareModal.classList.add("pointer-events-none");
        }, 300); // Match transition duration
      };

      shareBtn?.addEventListener("click", (e) => {
        e.stopPropagation();
        openModal();
      });

      closeModalBtn?.addEventListener("click", closeModal);

      // Close on outside click
      shareModal?.addEventListener("click", (e) => {
        if (e.target === shareModal) {
          closeModal();
        }
      });

      // Copy link functionality
      const copyLinkBtn = document.getElementById("copy-link-btn");
      const shareLinkInput = document.getElementById("share-link-input");
      const copyText = document.getElementById("copy-text");
      const copyIcon = document.getElementById("copy-icon");
      const copiedIcon = document.getElementById("copied-icon");

      const panel = document.getElementById("floating-panel");
      let hideTimeout;

      function showPanel() {
        panel.classList.remove("-translate-x-[90%]");
        panel.classList.add("translate-x-0");

        clearTimeout(hideTimeout);
        hideTimeout = setTimeout(hidePanel, 5000);
      }

      function hidePanel() {
        panel.classList.add("-translate-x-[90%]");
        panel.classList.remove("translate-x-0");
      }

      panel.addEventListener("click", (e) => {
        e.stopPropagation();
        showPanel();
      });

      window.addEventListener("scroll", () => {
        hidePanel();
      });

      copyLinkBtn?.addEventListener("click", () => {
        navigator.clipboard
          .writeText(shareLinkInput.value)
          .then(() => {
            copyText.textContent = '{{ __("Copied!") }}';
            copyIcon.classList.add("hidden");
            copiedIcon.classList.remove("hidden");

            setTimeout(() => {
              copyText.textContent = '{{ __("Copy") }}';
              copyIcon.classList.remove("hidden");
              copiedIcon.classList.add("hidden");
            }, 2000);
          })
          .catch((err) => {
            console.error("Failed to copy text: ", err);
            copyText.textContent = '{{ __("Failed!") }}';
            setTimeout(() => {
              copyText.textContent = '{{ __("Copy") }}';
            }, 2000);
          });
      });
    });
  </script>
</BlogPost>
